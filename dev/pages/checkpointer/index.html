<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Checkpointer · IMUDevNNTrainingLib</title><meta name="title" content="Checkpointer · IMUDevNNTrainingLib"/><meta property="og:title" content="Checkpointer · IMUDevNNTrainingLib"/><meta property="twitter:title" content="Checkpointer · IMUDevNNTrainingLib"/><meta name="description" content="Documentation for IMUDevNNTrainingLib."/><meta property="og:description" content="Documentation for IMUDevNNTrainingLib."/><meta property="twitter:description" content="Documentation for IMUDevNNTrainingLib."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">IMUDevNNTrainingLib</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../plateau_detector/">Plateau Detector</a></li><li class="is-active"><a class="tocitem" href>Checkpointer</a></li><li><a class="tocitem" href="../pretty_printing/">Printing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Checkpointer</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Checkpointer</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/main/docs/src/pages/checkpointer.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Checkpointing"><a class="docs-heading-anchor" href="#Checkpointing">Checkpointing</a><a id="Checkpointing-1"></a><a class="docs-heading-anchor-permalink" href="#Checkpointing" title="Permalink"></a></h1><p><code>Lux</code> is agnostic with respect to the way the user checkpoints the trained models. In particular the data-saving backend, the naming conventions and the choice of objects that need saving are all left up to the user. Although great from the perspective of flexibility, it calls for writing quite an extensive boilerplate code. <code>IMUDevNNTrainingLib</code> makes all those choices for the user and in return streamlines the checkpointing process. In particular, the following choices are made:</p><ul><li><a href="https://github.com/JuliaIO/JLD2.jl"><code>JLD2</code></a> is used as a backend for saving the state of the trained Neural Net</li><li>A checkpoint comprises of saved:<ul><li><code>model_parameters</code>: parameters of the trained Neural Network</li><li><code>model_states</code>: states (i.e. non-trainable parameters) of the trained Neural Network</li><li><code>opt_state</code>: parameters of the optimizer</li><li><code>log</code>: a training log (with loss functions)</li><li><code>other</code>: a dictionary of any other parameters that the user wishes to save. For instance, <code>plateau_detector</code> may be saved here.</li></ul></li><li>Names of checkpoints take the format <code>checkpoint=$(epoch).jld2</code>, where <code>$(epoch)</code> is the index of the epoch at the end of which the checkpoint has been made.</li></ul><p>The main object is <code>Checkpointer</code>:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.Checkpointer" href="#IMUDevNNTrainingLib.Checkpointer"><code>IMUDevNNTrainingLib.Checkpointer</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">Checkpointer(;
    dir::String = &quot;.&quot;,
    continue_from::Union{Int,Symbol} = :last,
    save_every::Int = 1)</code></pre><p>A struct to manage checkpoints during training of neural networks.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The checkpointer is intended to save:</p><ul><li>the model parameters</li><li>the model state</li><li>the optimizer state</li><li>the training log</li><li>other objects passed by the user</li></ul><p>Note in particular that it is not recommended to save the <code>model</code> itself.</p></div></div><ul><li><p><code>dir::String</code>: Root directory where the checkpoints will be saved to</p></li><li><p><code>continue_from::Union{Int64, Symbol}</code>: A default behaviour for resuming checkpointing. See <a href="#IMUDevNNTrainingLib.start"><code>start</code></a> for details.</p></li></ul><ul><li><code>save_every::Int64</code>: The frequency of saving checkpoints. A checkpoint will be saved every <code>save_every</code> epochs.</li></ul><p><strong>Examples</strong></p><p><strong>Checkpointing during training</strong></p><pre><code class="language-julia hljs">using Lux, Optimisers
using Random

rng = Random.default_rng()
Random.seed!(rng, 0)

# a function that updates the training log
model = ...
update_log!(...) = ...
ch = Checkpointer(dir=joinpath(homedir(), &quot;checkpoints&quot;),
                  continue_from=:last,
                  save_every=5)
chkp_data, start_epoch = start(ch)
parameters, states, opt_state, log, other = chkp_data

for epoch in start_epoch:100
    train!(parameters, states, model, data, opt_state)
    update_log!(log, model, data, epoch)
    checkpoint(ch, epoch; parameters, states, opt_state, log, other)
end</code></pre><p><strong>Loading checkpoint for testing</strong></p><pre><code class="language-julia hljs">model = Chain(...)
ch = Checkpointer(dir=joinpath(homedir(), &quot;checkpoints&quot;))
chkp_data = load_checkpoint(model, path_to_last_checkpoint(ch))
test(model, chkp_data, data)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L1-L56">source</a></section></article><p>The usual training workflow involves <code>start</code>ing it (which will load the specified checkpoint) as well as <code>checkpoint</code>ing it on every epoch, which will save the model when appropriate:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.start" href="#IMUDevNNTrainingLib.start"><code>IMUDevNNTrainingLib.start</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">start(cp::Checkpointer;
      move_to_device=Lux.cpu_device(),
      continue_from=cp.continue_from)</code></pre><p>Start the checkpointing process. <code>continue_from</code> can be one of the following:</p><ul><li><code>:none</code>, <code>:start</code>, <code>:restart</code>, <code>:nothing</code>: for starting from scratch;</li><li><code>:last</code>, <code>:latest</code>, <code>:recent</code>: for continuing from the last checkpoint;</li><li><code>Int</code>: for continuing from a specific checkpoint index.</li></ul><p>The <code>move_to_device</code> function is used to move the model parameters, model states and optimizer&#39;s state to the desired device (e.g. CPU or GPU). The function returns a <code>NamedTuple</code> with the checkpointed data (or <code>nothing</code> if no checkpoint is found) and an index of the subsequent training epoch.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L170-L184">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.checkpoint" href="#IMUDevNNTrainingLib.checkpoint"><code>IMUDevNNTrainingLib.checkpoint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">checkpoint(cp::Checkpointer, epoch::Int; model, opt_state, log, kwargs...)</code></pre><p>Save the model, the optimizer state and the training log to a checkpoint file if the given epoch is a multiple of <code>cp.save_every</code>. Otherwise, do nothing.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L246-L251">source</a></section></article><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Sometimes the user may wish to save and, perhaps, update additional variables. For instance a common use case would be to save the state of the <a href="../plateau_detector/#IMUDevNNTrainingLib.PlateauDetector"><code>PlateauDetector</code></a>. In that case the following could be done:</p><pre><code class="language-julia hljs">model = ...
ch = Checkpointer()
chkp_data, start_epoch = start(ch)
if isnothing(chkp_data)
    do_custom_initialization()
end
pd = chkp_data.other[:plateau_detector]</code></pre><p>and if we&#39;d like to start using a different schedule of learning rates we could adjust them with:</p><pre><code class="language-julia hljs">new_schedule = ParameterSchedulers.Stateful(Exp(1e-3, 0.15))
Optimisers.adjust!(chkp_data.opt_state, pd, new_schedule)</code></pre><p>before we resume the training.</p></div></div><p>For testing it is often enough to call <code>load_checkpoint</code> directly, instead of trying to establish the starting epoch as well:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.load_checkpoint" href="#IMUDevNNTrainingLib.load_checkpoint"><code>IMUDevNNTrainingLib.load_checkpoint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">load_checkpoint(path::String; move_to_device=Lux.cpu_device())</code></pre><p>Load the model parameters, model states, optimizer state, training log and the remaining variables from the checkpoint file. <code>move_to_device</code> is used to move the:</p><ul><li>model parameters</li><li>model states and</li><li>optimizer&#39;s state</li></ul><p>to the desired device (e.g. CPU or GPU).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L222-L232">source</a></section></article><p>To pick the appropriate checkpoint one can make use of the following helper functions:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.path_to_checkpoint" href="#IMUDevNNTrainingLib.path_to_checkpoint"><code>IMUDevNNTrainingLib.path_to_checkpoint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">path_to_checkpoint(cp::Checkpointer, epoch::Int)</code></pre><p>Return the path to the checkpoint file for the given epoch.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>This function does not check if the file exists.</p></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L72-L79">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.index_of_last_checkpoint" href="#IMUDevNNTrainingLib.index_of_last_checkpoint"><code>IMUDevNNTrainingLib.index_of_last_checkpoint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">index_of_last_checkpoint(cp::Checkpointer)</code></pre><p>Return the index of the most recent checkpoint in the directory <code>cp.dir</code>. Return <code>nothing</code> if no checkpoint exists.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L110-L115">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.path_to_last_checkpoint" href="#IMUDevNNTrainingLib.path_to_last_checkpoint"><code>IMUDevNNTrainingLib.path_to_last_checkpoint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">path_to_last_checkpoint(cp::Checkpointer)</code></pre><p>Return the path to the most recent checkpoint file for the given epoch.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L84-L88">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.index_of_last_checkpoint_prior_to" href="#IMUDevNNTrainingLib.index_of_last_checkpoint_prior_to"><code>IMUDevNNTrainingLib.index_of_last_checkpoint_prior_to</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">index_of_last_checkpoint_prior_to(cp::Checkpointer, i::Int)</code></pre><p>Return the index of the most recent checkpoint in the directory <code>cp.dir</code> out of checkpoints that are prior to the given index <code>i</code>. Return <code>nothing</code> if no such checkpoint exists.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L122-L128">source</a></section></article><p>A typical example of loading for testing is given below:</p><pre><code class="language-julia hljs"># define model architecture
model = ...

chkp = Checkpointer(; dir=&quot;saved_checkpoints&quot;)
chkp_data = load_checkpoint(model, path_to_last_checkpoint(chkp))</code></pre><p>To list available checkpoint indices you may use:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IMUDevNNTrainingLib.list_existing_checkpoint_indices" href="#IMUDevNNTrainingLib.list_existing_checkpoint_indices"><code>IMUDevNNTrainingLib.list_existing_checkpoint_indices</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">list_existing_checkpoint_indices(cp::Checkpointer)</code></pre><p>List the epoch indices of the existing checkpoints in the directory <code>cp.dir</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/imu-dev/IMUDevNNTrainingLib.jl/blob/b4d9e0a6872c292bbd1157d51d4316e19dc4379f/src/checkpointer.jl#L95-L99">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../plateau_detector/">« Plateau Detector</a><a class="docs-footer-nextpage" href="../pretty_printing/">Printing »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Tuesday 5 March 2024 17:07">Tuesday 5 March 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
